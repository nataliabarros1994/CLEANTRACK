{% extends "base/base.html" %}
{% load static %}

{% block title %}Registrar Limpeza - CleanTrack{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header Card -->
    <div class="card-responsive bg-gradient-to-r from-indigo-600 to-purple-600 text-white mb-6">
        <div class="text-center">
            <i class="fas fa-spray-can text-4xl mb-3"></i>
            <h1 class="text-2xl md:text-3xl font-bold">Registrar Limpeza</h1>
            <p class="text-indigo-100 mt-2">Equipamento Médico</p>
        </div>
    </div>

    <!-- Equipment Info Card -->
    {% if equipment %}
    <div class="card-responsive mb-6">
        <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-microscope text-2xl text-indigo-600"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <h2 class="text-xl font-semibold text-gray-900 truncate">{{ equipment.name }}</h2>
                <p class="text-gray-600 mt-1">
                    <i class="fas fa-barcode mr-1"></i>
                    Serial: <span class="font-mono">{{ equipment.serial_number }}</span>
                </p>
                <p class="text-gray-600 mt-1">
                    <i class="fas fa-map-marker-alt mr-1"></i>
                    {{ equipment.location }}
                </p>
                {% if equipment.facility %}
                <p class="text-gray-600 mt-1">
                    <i class="fas fa-hospital mr-1"></i>
                    {{ equipment.facility.name }}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Last Cleaning Info -->
        {% if equipment.last_cleaning %}
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-800">
                <i class="fas fa-check-circle mr-1"></i>
                <strong>Última limpeza:</strong> {{ equipment.last_cleaning|date:"d/m/Y H:i" }}
            </p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-error{% else %}alert-warning{% endif %}">
            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Registration Form -->
    <div class="card-responsive">
        <form method="post" enctype="multipart/form-data" id="cleaning-form" class="space-y-6">
            {% csrf_token %}

            <!-- Cleaned By (optional) -->
            <div class="form-group">
                <label for="id_cleaned_by" class="form-label">
                    <i class="fas fa-user mr-1"></i>
                    Realizado por (opcional)
                </label>
                <input
                    type="text"
                    name="cleaned_by"
                    id="id_cleaned_by"
                    class="form-input"
                    placeholder="Nome do técnico/responsável"
                    autocomplete="name"
                >
                <p class="text-sm text-gray-500 mt-1">Se não preencher, será registrado como "Técnico Anônimo"</p>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label for="id_notes" class="form-label">
                    <i class="fas fa-clipboard mr-1"></i>
                    Observações
                </label>
                <textarea
                    name="notes"
                    id="id_notes"
                    rows="4"
                    class="form-input resize-none"
                    placeholder="Descreva o procedimento de limpeza realizado, produtos utilizados, condições do equipamento, etc."
                ></textarea>
            </div>

            <!-- Photo Upload -->
            <div class="form-group">
                <label for="id_photo" class="form-label">
                    <i class="fas fa-camera mr-1"></i>
                    Foto do Equipamento Limpo (opcional)
                </label>

                <!-- Custom file input -->
                <div class="relative">
                    <input
                        type="file"
                        name="photo"
                        id="id_photo"
                        accept="image/*"
                        capture="environment"
                        class="hidden"
                        onchange="previewPhoto(this)"
                    >
                    <button
                        type="button"
                        onclick="document.getElementById('id_photo').click()"
                        class="w-full btn-touch bg-gray-100 border-2 border-dashed border-gray-300 hover:border-indigo-400 text-gray-600 hover:text-indigo-600 transition-colors"
                    >
                        <i class="fas fa-camera text-2xl mb-2"></i>
                        <p class="font-medium">Tirar Foto ou Escolher da Galeria</p>
                        <p class="text-sm mt-1">Toque para adicionar uma foto</p>
                    </button>
                </div>

                <!-- Photo Preview -->
                <img id="photo-preview" class="photo-preview hidden" alt="Preview da foto">

                <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Recomendado: Foto do equipamento após a limpeza
                </p>
            </div>

            <!-- Submit Button -->
            <div class="space-y-3">
                <button
                    type="submit"
                    class="w-full btn-touch bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold hover:from-indigo-700 hover:to-purple-700 shadow-lg"
                >
                    <i class="fas fa-check-circle mr-2"></i>
                    Confirmar Limpeza
                </button>

                {% if equipment %}
                <a
                    href="{% url 'admin:equipment_equipment_change' equipment.id %}"
                    class="w-full btn-touch bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 text-center block"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar ao Equipamento
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Help Card -->
    <div class="card-responsive bg-blue-50 border border-blue-200 mt-6">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-2xl text-blue-600 mr-3 mt-1"></i>
            <div>
                <h3 class="font-semibold text-blue-900 mb-2">Como usar este formulário</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li><i class="fas fa-check mr-1"></i> Preencha seus dados (opcional)</li>
                    <li><i class="fas fa-check mr-1"></i> Adicione observações sobre a limpeza</li>
                    <li><i class="fas fa-check mr-1"></i> Tire uma foto do equipamento limpo (opcional)</li>
                    <li><i class="fas fa-check mr-1"></i> Clique em "Confirmar Limpeza"</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Token Expiry Warning -->
    {% if token_expires_soon %}
    <div class="alert alert-warning mt-6">
        <i class="fas fa-clock mr-2"></i>
        <strong>Atenção:</strong> Este link expira em breve. Complete o registro rapidamente.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form submission with loading state
    document.getElementById('cleaning-form').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Registrando...';
    });

    // Auto-resize textarea
    const textarea = document.getElementById('id_notes');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }

    // Vibrate on photo capture (if supported)
    document.getElementById('id_photo').addEventListener('change', function() {
        if ('vibrate' in navigator) {
            navigator.vibrate(50);
        }
    });
</script>
{% endblock %}
